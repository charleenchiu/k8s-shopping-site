# 功能說明書：k8s-shopping-site Dockerfile (3_python_nosql)

## 一、概述
此 `Dockerfile` 用於構建 `k8s-shopping-site` 專案的 Docker 映像，將應用程式包裝成可部署的容器，整個流程基於 Python 與 MongoDB。該映像定義了從設定環境、安裝依賴到啟動應用的步驟。構建完成的映像能夠在容器環境中直接運行，並適合用於 Kubernetes 部署。

## 二、核心組件

### 1. 使用 Python 官方映像
```dockerfile
FROM python:3.9
```
- 使用 Python 的官方映像作為基礎映像，並指定 Python 版本為 `3.9`，以便維持開發與生產環境的一致性。

### 2. 設定工作目錄
```dockerfile
WORKDIR /usr/src/app
```
- 設置容器內的工作目錄為 `/usr/src/app`，所有後續操作都會在此目錄下進行，保持目錄結構清晰且統一。

### 3. 複製依賴管理檔案
```dockerfile
COPY requirements.txt ./
```
- 將 `requirements.txt` 檔案複製到工作目錄中，此檔案包含了應用程式所需的 Python 套件清單，Docker 會根據此檔案來安裝依賴。

### 4. 安裝應用程式依賴
```dockerfile
RUN pip install --no-cache-dir -r requirements.txt
```
- 執行 `pip install` 安裝所有依賴，並啟用 `--no-cache-dir` 選項以減少映像大小，確保應用程式運行所需的所有庫。

### 5. 複製應用程式檔案
```dockerfile
COPY . .
```
- 將專案目錄下的所有檔案複製到容器內的工作目錄，確保程式碼和資源都包含在映像中。

### 6. 設定環境變數
- 容器會透過 `docker-compose.yml` 設定的環境變數與其他服務通訊。各個服務的環境變數包含下列變數：
  - `NODE_ENV`: 設定環境為生產模式。
  - `USER_SERVICE_URL`, `PRODUCT_SERVICE_URL` 等：不同微服務的連接資訊。
  - `EC2_PRIVATE_IP`, `USE_CONTAINER`, `HOST`：設置伺服器位置、執行模式和主機名等。

### 7. 暴露應用程式的埠號
```dockerfile
EXPOSE 3000
```
- 開放容器內的 `3000` 埠，使應用程式能接收來自外部的請求。

### 8. 啟動應用程式
```dockerfile
CMD ["python", "app.py"]
```
- 設定容器啟動時執行的指令為 `python app.py`，即運行應用程式的主檔案 `app.py`，啟動後應用程式將自動執行。

## 三、`docker-compose.yml` 使用方式

1. **設定多服務架構**：
   `docker-compose.yml` 定義了 `site-service`、`user-service`、`product-service`、`order-service` 和 `payment-service` 等微服務。每個服務都有以下重要配置：
   - **build**：指定 Dockerfile 位置，用於構建該服務的映像。
   - **ports**：設置容器內部埠與主機埠之間的對映。
   - **environment**：定義環境變數，適應不同服務間的通訊需求。
   - **networks**：設定網路隔離，便於不同服務間的網路互連。

2. **啟動多容器應用程式**：
   - 執行 `docker-compose up --build` 命令，根據 `docker-compose.yml` 檔案定義啟動各個服務，並自動構建映像。
   - 在啟動後，可以通過以下 URL 訪問各服務：
     - `http://localhost:<服務埠號>` (例如 `http://localhost:3000` 用於 `site-service`)

3. **停止與移除容器**：
   - 執行 `docker-compose down` 停止並移除所有容器，保持系統整潔。

## 四、總結
此 `Dockerfile` 和 `docker-compose.yml` 文件設定可以快速構建 `k8s-shopping-site` 專案的多容器環境，包含 Python 和 MongoDB 的支持，適合用於 Kubernetes 等微服務架構的容器化部署。標準化的映像構建流程不僅確保了應用程式的穩定性與一致性，也方便了服務之間的互通，提升整體開發與部署效率。