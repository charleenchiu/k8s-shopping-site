# 功能說明書：清理 ECR 映像 (`delete_ecr_images.sh`)

### 檔案位置
- 路徑：`terraform\delete_ecr_images.sh`

### 功能概述
此 Bash 腳本負責從指定的 AWS ECR 公共儲存庫中刪除所有映像。透過指定的區域與儲存庫名稱，腳本先取得各儲存庫中映像的 Digest，再逐一刪除。刪除過程中包含狀態訊息，若刪除失敗則會顯示錯誤提示。

### 功能詳述

1. **AWS 區域設定**
   - 設定變數 `region` 為 `us-east-1`，用於指定 AWS 區域。

2. **儲存庫列表**
   - 定義一個儲存庫陣列 `repositories`，包含 `k8s-shopping-site` 及其相關微服務的儲存庫路徑。
   - 儲存庫列表：
     - `k8s-shopping-site`
     - `k8s-shopping-site/payment_service`
     - `k8s-shopping-site/product_service`
     - `k8s-shopping-site/order_service`
     - `k8s-shopping-site/user_service`

3. **刪除流程**
   - 對於每個儲存庫：
     1. 顯示正在處理的儲存庫名稱。
     2. 使用 `aws ecr-public describe-images` 命令查詢該儲存庫中所有映像的 Digest。
     3. 若無法取得 Digest（例如儲存庫為空或不存在），顯示錯誤訊息並跳至下一個儲存庫。
     4. 若成功取得 Digest，逐一刪除每個映像：
        - 顯示正在刪除的 Digest。
        - 執行 `aws ecr-public batch-delete-image` 刪除該 Digest 對應的映像。
        - 若刪除失敗，顯示失敗訊息；成功則顯示成功訊息。

4. **結束訊息**
   - 當所有儲存庫的映像刪除完成後，顯示「All images deleted.」。

### 使用說明
在終端執行此腳本前，確保 AWS CLI 已安裝且配置好相應的 AWS 使用者憑證。執行 `./delete_ecr_images.sh` 後，腳本會自動刪除列出的 ECR 儲存庫中所有映像。