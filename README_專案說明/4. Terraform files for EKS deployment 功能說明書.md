# 功能說明書：Terraform files for EKS deployment (`terraform\`)

### 檔案位置
- 路徑：`terraform\`

以下是 terraform 目錄下， `main.tf`、`variables.tf` 和 `outputs.tf` 的功能說明：

### 1. 功能概述
該 Terraform 配置用於設定 AWS 上的 EKS 叢集、Node Group、IAM 角色和相關資源，並配置 ECR 公共儲存庫來支援 Kubernetes 應用部署。此配置支援 EKS 與 AWS VPC 網路、IAM 角色權限控制，並管理 ECR 服務儲存容器映像。它提供了 Kubernetes 憑證管理與監控的 CloudWatch 日誌群組配置。

### 2. main.tf 功能說明
1. **IAM Cluster 角色**
   - 查詢現有 `eksClusterRole` 角色。
   - 設定 IAM 角色並附加 Amazon EKS Cluster 和 VPC Resource Controller 的策略。

2. **Cluster 權限策略**
   - 為 Cluster 角色新增 IAM 策略來授予 ECR、EKS、CloudWatchLogs 等全面訪問權限。

3. **Node Group 角色**
   - 查詢 `eksNodeGroupRole` 角色並附加對應的權限策略 (ECR Pull Only/Read Only、Worker Node Policy)。

4. **EKS Cluster**
   - 配置並創建 EKS 叢集，並指定 Cluster 使用的 VPC 子網。

5. **CloudWatch 日誌群組**
   - 建立 CloudWatch 日誌群組 `/eks/k8s-shopping-site_task`，設置保存週期為 7 天。

6. **EKS Node Group**
   - 配置 EKS Node Group，指定節點數量及執行類型 (`t3.medium`)，與 EKS Cluster 建立連接。

7. **公共 ECR 儲存庫**
   - 創建應用程式和每個微服務的公共 ECR 儲存庫，包含 `k8s-shopping-site`、`user_service`、`product_service`、`order_service` 和 `payment_service`。

### 3. variables.tf 功能說明
- **VPC ID 和 Subnet IDs**
  - 定義 VPC 及 Subnet ID（`vpc-02fb581658eb58d45`）和子網 (`subnet-0153eaf2e8d59b0a0`、`subnet-01a1ebac945fa5853`)，作為 EKS 叢集和 Node Group 的網路配置基礎。

### 4. outputs.tf 功能說明
- **ECR Repo URI 輸出**
  - 輸出公共 ECR 儲存庫 URI（包括主應用及各微服務的儲存庫），方便後續應用部署引用。

- **EKS Cluster 信息**
  - 輸出 EKS Cluster 名稱、ARN、API URL 和 CA 資料，用於 Kubernetes 憑證和連線配置。

- **CloudWatch 日誌群組**
  - 輸出 CloudWatch 日誌群組的名稱，提供日誌存取資訊。

### 5. 總結
本配置提供了一個完整的 EKS 叢集與資源管理方案，涵蓋 IAM 角色、EKS Cluster、Node Group、ECR 儲存庫和 CloudWatch 日誌管理的基礎設置。透過 `outputs.tf` 中的輸出，將配置的資源資訊暴露給其他模組或進一步的自動化流程。