## Functionality Report - `Jenkinsfile`

### File Overview
This `Jenkinsfile` defines a Jenkins Pipeline that uses Terraform to automate the configuration of AWS infrastructure. The process features allowing users to choose whether to automatically execute the `apply` step and supports Ansible deployment and verification workflows. The Pipeline primarily encompasses steps for Git code repository cloning, Terraform plan generation and application, and optional deployment, thus achieving automation in the CI/CD process.

### Pipeline Stages Description

---

### 1. **Parameters Stage**
**Function**: Provides the `autoApprove` parameter for users to choose whether to automatically execute Terraform `apply`, allowing for manual review or automatic application after generating the `plan`.

---

### 2. **Environment Setup Stage**
**Function**: Extracts AWS credentials from Jenkins Credential Management and stores them in the environment variables `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` for secure access to AWS resources during the Pipeline.

---

### 3. **Git Clone Stage**
**Function**: This stage clones code from the `cicd-kube` branch of the GitHub repository into the `terraform` directory in the Jenkins workspace, allowing subsequent steps in the Pipeline to use the latest code.

- **Steps**
  - **Failure Handling**: If cloning fails, an error message `[ *] git clone failure` will be displayed.
  - **Success Handling**: If cloning succeeds, a success message `[ *] git clone successful` will be displayed.

---

### 4. **Terraform Plan Stage**
**Function**: This stage initializes Terraform, generating and storing an infrastructure change plan for subsequent review or automatic execution.

- **Steps**
  - **Check Identity and Directory**: Execute `whoami` and `pwd` to verify the execution environment.
  - **Terraform Initialization**: Run `terraform init` to download necessary modules and plugins.
  - **Generate Plan**: Use `terraform plan -out tfplan` to create a plan and save it to the `tfplan` file.
  - **Plan Output**: Generate a non-colorized text format plan, stored in `tfplan.txt` for manual review.

---

### 5. **Terraform Approval Stage**
**Function**: In this stage, if `autoApprove` is set to `false`, manual approval for the plan is required to prevent unexpected changes.

- **Steps**
  - **Display Plan Content**: Read the plan content from `tfplan.txt` and display it for user review.
  - **Manual Confirmation**: Show a message for the user to choose whether to execute `apply`. This step provides a review window to ensure the plan meets expectations.

---

### 6. **Terraform Apply Stage**
**Function**: If the plan is approved, execute `terraform apply` to implement infrastructure changes and configure the infrastructure in the AWS environment.

- **Steps**
  - **Apply Plan**: Use the command `terraform apply -input=false tfplan` to quickly apply the infrastructure settings.

---

### 7. **Optional Stages**
These steps are optional but, if enabled, will execute further infrastructure configuration and Ansible deployment.

1. **Set Private Key Permissions**: Set the permission of the private key file to 600 to enhance file security.
  
2. **Ansible Deployment**: Execute the Ansible Playbook for application or infrastructure settings, while disabling SSH host key checking.

3. **Ansible Version Check**: List the versions of various Ansible tools for confirmation of version requirements.

4. **Retrieve Private Key File and Set Permissions**: Use the private key generated by Terraform and set appropriate permissions to ensure Jenkins can securely access the remote host.

5. **Write EC2 IP to Ansible Inventory and Execute Playbook**: Add the newly created EC2 public IP address to the Ansible inventory file and execute the specified Playbook.

---

### Key Variables

- `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`: AWS credentials in Jenkins Credential Management, ensuring secure access to AWS resources during the Pipeline process.
- `autoApprove`: A boolean variable that allows users to choose whether to automatically execute `apply` after generating the plan, adding flexibility.

---

### Conclusion

This `Jenkinsfile` provides a CI/CD Pipeline with flexibility and security, integrating Git environment configuration, Terraform infrastructure management, and Ansible deployment capabilities. This Pipeline design is suitable for tiered infrastructure setting requirements and supports workflows with manual review.